
<!DOCTYPE HTML>
<html lang="id" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Pod Autoscaler - Devops Tutorial</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    

    <script data-ad-client="ca-pub-1417781814120840" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script><script>!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');fbq('init','1247398778924723');fbq('track','PageView');</script><noscript><imgheight="1"width="1"style="display:none"src="https://www.facebook.com/tr?id=1247398778924723&ev=PageView&noscript=1"/></noscript><link rel="stylesheet" href="/id/adjustment.css?v=1.2020.06.12.091147"></head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Amazon Web Services (AWS)
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="aws-membuat-user-iam.html">
            
                <a href="aws-membuat-user-iam.html">
            
                    
                    Membuat User IAM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Docker
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="docker-push-image-ke-hub.html">
            
                <a href="docker-push-image-ke-hub.html">
            
                    
                    Push Image ke hub.docker.com
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Kubernetes
            
                </span>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7" data-path="kubernetes-minikube-deployment-service-horizontal-autoscale.html">
            
                <a href="kubernetes-minikube-deployment-service-horizontal-autoscale.html">
            
                    
                    Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Pod Autoscaler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <span>
            
                    
                    Terraform
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="terraform-aws-ec2-internet-gateway-ssh.html">
            
                <a href="terraform-aws-ec2-internet-gateway-ssh.html">
            
                    
                    Terraform - Otomatisasi setup AWS EC2, Internet Gateway, dan SSH
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="terraform-aws-load-balancer-auto-scaling.html">
            
                <a href="terraform-aws-load-balancer-auto-scaling.html">
            
                    
                    Terraform - Otomatisasi setup EC2, Application Load Balancer, dan Auto Scaling
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Pod Autoscaler</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="kubernetes---deploy-aplikasi-ke-kluster-minikube-menggunakan-deployment-controller-service-dan-horizontal-pod-autoscaler">Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Pod Autoscaler</h1>
<p>Pada tutorial kali ini, kita akan belajar cara men-<em>deploy</em> aplikasi <em>containerized</em> ke kluster kubernetes (minikube), meng-<em>enable</em> kapabilitas autoscaling, dan menyiapkan <em>service</em> untuk membuat aplikasi tersebut menjadi dapat diakses dari luar kluster.</p>
<p>Aplikasi yang akan di-deploy adalah aplikasi hello world sederhana dikembangkan menggunakan bahasa Go. Aplikasinya sudah jadi dan siap dipakai, sudah <em>dockerized</em> juga, dan image nya tersedia di <a href="https://hub.docker.com/repository/docker/novalagung/hello-world" target="_blank">Docker Hub</a>.</p>
<p>Jika teman-teman ingin men-deploy aplikasi lain, silakan. Siapkan saja image nya dan push ke Docker Hub. Bisa mengikuti panduan berikut untuk caranya <a href="docker-push-image-to-hub.html">Push Image ke hub.docker.com</a>.</p>
<hr>
<h3 id="1-kebutuhan">1. Kebutuhan</h3>
<h4 id="11-docker-engine">1.1. Docker engine</h4>
<p>Pastikan Docker engine adalah <em>running</em>. Jika di lokal belum ter-<em>install</em> Docker engine, maka <em>install</em> terlebih dahulu.</p>
<h4 id="12-minikube">1.2. Minikube</h4>
<p>Pastikan Minikube sudah <em>running</em>. Jalankan command <code>minikube start</code> pada PowerShell yang dibuka dengan admin privilege. Jika belum ter-<em>install</em>, maka silakan <em>install</em> terlebih dahulu.</p>
<h4 id="13-kubernetes-cli-tool">1.3. Kubernetes CLI tool</h4>
<p>Pastikan command <code>kubectl</code> sudah di-<em>install</em>. Jika belum ter-<em>install</em>, maka silakan <em>install</em> terlebih dahulu.</p>
<h4 id="14-hey-tool-http-load-generator">1.4. <code>hey</code> tool (HTTP load generator)</h4>
<p><em>Install</em> tool ini di lokal. Panduan instalasi ada di <a href="https://github.com/rakyll/hey" target="_blank">https://github.com/rakyll/hey</a>.</p>
<p><code>hey</code> merupakan <em>benchmark tool</em>, mirip seperti Apache Benchmark. Nantinya kita akan menggunakan tool kecil ini untuk melakukan <em>stress test</em> pada aplikasi kita, untuk memastikan kapabilitas auto scaling berjalan sesuai harapan.</p>
<hr>
<h3 id="2-persiapan">2. Persiapan</h3>
<h4 id="21-khusus-untuk-pengguna-windows-gunakan-powershell-yang-dibuka-dengan-admin-privilege">2.1. Khusus untuk pengguna Windows, gunakan PowerShell yang dibuka dengan admin privilege</h4>
<p>Tidak dianjurkan menggunakan Command Prompt atau CMD. Gunakan PowerShell yang dibuka dengan admin privilege.</p>
<h4 id="22-buat-file-konfigurasi-objek-kubernetes-dengan-ekstensi-yaml">2.2. Buat file konfigurasi objek Kubernetes (dengan ekstensi <code>.yaml</code>)</h4>
<p>Nantinya kita akan buat tiga buah objek Kubernetes, yaitu: deployment, horizontal pod auto scaler, dan service.</p>
<p>Untuk mempermudah proses pembelajaran, ketiga konfigurasi objek yang disebutkan di atas akan di tulis dalam satu file konfigurasi saja.</p>
<p>Ok, langsung saja, buat file bernama <code>k8s.yaml</code> (atau bisa gunakan nama lain, bebas). Buka file tersebut lewat editor favorit teman-teman.</p>
<hr>
<h3 id="3-pendefinisian-objek">3. Pendefinisian Objek</h3>
<h4 id="31-objek-deployment">3.1. Objek Deployment</h4>
<p>Deployment adalah sebuah objek <em>controller</em> yang digunakan untuk manajemen pod dan replica sets. Pada bagian ini kita akan buat objek tersebut.</p>
<p>Pada file <code>k8s.yaml</code>, tulis konfigurasi di bawah ini. Silakan dibaca dan dipahami juga komentar yang ada pada bagian-bagian konfigurasi untuk tau kegunaan dari masing-masing bagian.</p>
<pre><code class="lang-yaml"><span class="hljs-meta">---</span>
<span class="hljs-comment"># ada banyak API yang tersedia pada Kubernetes</span>
<span class="hljs-comment"># (untuk cek, bisa gunakan command `kubectl api-versions`).</span>
<span class="hljs-comment"># pada blok kode deployment berikut, kita pilih API `apps/v1`.</span>
<span class="hljs-attr">apiVersion:</span> apps/v1

<span class="hljs-comment"># alokasikan blok kode YAML ini untuk deployment object.</span>
<span class="hljs-attr">kind:</span> Deployment

<span class="hljs-comment"># namai objek dengan `my-app-deployment`.</span>
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> my-app-deployment

<span class="hljs-comment"># blok spec berikut berisi spesifikasi behaviour dari objek deployment ini.</span>
<span class="hljs-attr">spec:</span>

  <span class="hljs-comment"># selector.matchLabels digunakan untuk menentukan pod mana yg akan di-manage oleh deployment.</span>
  <span class="hljs-comment"># deployment akan me-manage semua pod yang sesuai dengan selektor ini.</span>
<span class="hljs-attr">  selector:</span>
<span class="hljs-attr">    matchLabels:</span>
<span class="hljs-attr">      app:</span> my-app

  <span class="hljs-comment"># blok kode template berikut berisi informasi bagaiaman pod akan dibuat.</span>
<span class="hljs-attr">  template:</span>

    <span class="hljs-comment"># tambahkan label pada pod dengan value adalah `my-app`.</span>
<span class="hljs-attr">    metadata:</span>
<span class="hljs-attr">      labels:</span>
<span class="hljs-attr">        app:</span> my-app

    <span class="hljs-comment"># blok spec berikut berisi spesifikasi behaviour dari objek pod `my-app`.</span>
<span class="hljs-attr">    spec:</span>

      <span class="hljs-comment"># list dari kontainer dalam pod `my-app`.</span>
<span class="hljs-attr">      containers:</span>

          <span class="hljs-comment"># alokasikan kontainer baru dengan nama `hello-world`.</span>
<span class="hljs-attr">        - name:</span> hello-world

          <span class="hljs-comment"># image dari container ini di-pull dari Docker Hub repo `novalagung/hello-world`.</span>
          <span class="hljs-comment"># jika image tersebut belum ada di lokal, maka akan otomatis di pull.</span>
<span class="hljs-attr">          image:</span> novalagung/hello-world

          <span class="hljs-comment"># beberapa environment variables yang dibutuhkan container ini.</span>
          <span class="hljs-comment"># lebih jelasnya bisa cek ke</span>
          <span class="hljs-comment"># https://hub.docker.com/repository/docker/novalagung/hello-world.</span>
<span class="hljs-attr">          env:</span>
<span class="hljs-attr">            - name:</span> PORT
<span class="hljs-attr">              value:</span> <span class="hljs-string">&quot;8081&quot;</span>
<span class="hljs-attr">            - name:</span> INSTANCE_ID
<span class="hljs-attr">              valueFrom:</span>
<span class="hljs-attr">                fieldRef:</span>
<span class="hljs-attr">                  fieldPath:</span> metadata.name

          <span class="hljs-comment"># pod ini hanya akan memiliki satu kontainer saja, yaitu `hello-world` di atas,</span>
          <span class="hljs-comment"># dan yang akan terjadi dalam kontainer ini adalah: sebuah web server di-start</span>
          <span class="hljs-comment"># pada port `8081`.</span>
          <span class="hljs-comment"># port tersebut di-expose agar bisa diakses dari luar pod dalam kluster.</span>
<span class="hljs-attr">          ports:</span>
<span class="hljs-attr">            - containerPort:</span> <span class="hljs-number">8081</span>

          <span class="hljs-comment"># spec container `hello-world`.</span>
<span class="hljs-attr">          resources:</span>
<span class="hljs-attr">            limits:</span>
<span class="hljs-attr">              cpu:</span> <span class="hljs-number">250</span>m
<span class="hljs-attr">              memory:</span> <span class="hljs-number">32</span>Mi
</code></pre>
<p>Secara garis besar, blok kode di atas melakukan proses berikut (secara sekuensial):</p>
<ul>
<li>Membuat objek deployment bernama <code>my-app-deployment</code>.</li>
<li>Mendefinisikan spesifikasi pod (dalam objek deployment) yang berisi satu buah kontainer.</li>
<li>Kontainer tersebut bernama <code>hello-world</code>, image-nya di-pull dari Docker Hub.</li>
<li>Environment informasi PORT dan Instance ID di-definisikan untuk keperluan proses build container. Port tersebut digunakan oleh web server dalam kontainer.</li>
<li>Web server akan <em>listen to</em> port <code>8081</code> dan port ini di-expose ke luar. Artinya kita bisa mengakses web server tersebut dari luar pod (tapi masih dari dalam kluster).</li>
</ul>
<p>Ok, sekarang mari kita terapkan file konfigurasi di atas menggunakan command berikut:</p>
<pre><code class="lang-bash"><span class="hljs-comment"># terapkan konfigurasi</span>
kubectl apply <span class="hljs-_">-f</span> k8s.yaml

<span class="hljs-comment"># munculkan semua objek deployment</span>
kubectl get deployments

<span class="hljs-comment"># munculkan semua objek pod</span>
kubectl get pods
</code></pre>
<p style="text-align: center;">
  <img src="https://i.imgur.com/VXlFDch.png" alt="Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Autoscaler - run objek deployment">
</p>

<h4 id="31-test-salah-satu-pod">3.1. Test salah satu pod</h4>
<p>Pada gambar di atas bisa dilihat, deployment berjalan sesuai harapan. Ada dua buah pod yang <em>running</em>.</p>
<blockquote>
<p>Kenapa ada dua pod? kenapa tidak satu, tiga, atau lainnya. Hal ini karena kita tidak mendefinisikan <code>spec.replicas</code> objek deployment. Nilai default replikai adalah dua. Jika kita mendefinisikan replika dengan nilai empat (misalnya), maka akan langsung ter-create 4 buah pod secara default.</p>
</blockquote>
<p>Ok, mari kita coba lakukan testing. Kita akan coba <em>remotelly</em> konek ke salah satu pod, lalu mengecek apakah web server sudah <em>listen to</em> port <code>8081</code>.</p>
<pre><code class="lang-bash"><span class="hljs-comment"># munculkan semua objek pod</span>
kubectl get pods

<span class="hljs-comment"># konek ke salah satu pod</span>
kubectl <span class="hljs-built_in">exec</span> -it &lt;pod-name&gt; -- /bin/sh

<span class="hljs-comment"># cek apakah aplikasi/webserver yang listen ke port 8081</span>
netstat -tulpn | grep :8081
</code></pre>
<p style="text-align: center;">
  <img src="https://i.imgur.com/vdZaLf2.png" alt="Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Autoscaler - konek ke pod">
</p>

<p>Bisa dilihat pada image di atas, port tersebut digunakan oleh aplikasi/webserver.</p>
<h4 id="32-terapkan-perubahan-pada-objek-deployment">3.2. Terapkan perubahan pada objek deployment</h4>
<p>Selain objek deployment, ada juga jenis objek kontroler lainnya yang tersedia di k8s.</p>
<p>Salah satu kelebihan dari objek deployment dibanding objek kontroler lainnya adalah, setiap perubahan konfigurasi pod yang diterapkan, maka perubahan tersebut akan diterapkan secara <em>seamless</em>.</p>
<p>Ok, sekarang mari kita buktikan bahwa statement di atas adalah valid, yaitu dengan cara mengubah beberapa konfigurasi berikut lalu kemudian menerapkannya.</p>
<ul>
<li>Perubahan pada <code>containers.env.value</code>, arakhan nilai environment <code>PORT</code> ke <code>8080</code>. Sebelumnya mengarah ke <code>8081</code>.</li>
<li>Perubahan pada <code>containers.ports.containerPort</code>, arahkan nilainya ke <code>8080</code>. Sebelumnya mengarah ke <code>8081</code>.</li>
</ul>
<p>Di bawah ini adalah tampilan dari konfigurasi deployment setelah perubahan di atas diterapkan.</p>
<pre><code class="lang-bash">---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app-deployment
spec:
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
        - name: hello-world
          image: novalagung/hello-world
          env:
            - name: PORT
              value: <span class="hljs-string">&quot;8080&quot;</span> <span class="hljs-comment"># &lt;--- ubah dari 8081 ke 8080</span>
            - name: INSTANCE_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          ports:
            - containerPort: 8080 <span class="hljs-comment"># &lt;--- ubah dari 8081 ke 8080</span>
          resources:
            limits:
              cpu: 250m
              memory: 32Mi
</code></pre>
<p>Ok, sekarang terapkan konfigurasi yang baru di atas.</p>
<pre><code class="lang-bash"><span class="hljs-comment"># terapkan konfigurasi</span>
kubectl apply <span class="hljs-_">-f</span> k8s.yaml

<span class="hljs-comment"># munculkan semua pod</span>
kubectl get pods

<span class="hljs-comment"># konek ke salah satu pod</span>
kubectl <span class="hljs-built_in">exec</span> -it &lt;pod-name&gt; -- /bin/sh

<span class="hljs-comment"># cek apakah ada yang listen ke port 8080</span>
netstat -tulpn | grep :8080
</code></pre>
<p style="text-align: center;">
  <img src="https://i.imgur.com/DZWCTSk.png" alt="Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Autoscaler - terapkan perubahan objek deployment">
</p>

<p>Bisa dilihat, perubahan yang kita lakukan pada pod diaplikasikan secara alusss oleh kontroler deployment. Dan web server sekarang listen ke port 8080.</p>
<blockquote>
<p>Tips! Gunakan command berikut untuk menampilkan error log pada pod. Ini cukup berguna ketika pod container dalam pod tidak berjalan seperti rencana. Dari sini kita bisa tau error log yang menjelaskan error.</p>
<p><code>kubectl get pods</code><br><code>kubectl describe pod &lt;pod-name&gt;</code><br><code>kubectl logs &lt;pod-name&gt;</code></p>
</blockquote>
<h4 id="32-objek-service">3.2. Objek Service</h4>
<p>Service digunakan untuk menjembatani akses antar pod, baik dalam cluster maupun dari luar cluster.</p>
<p>Pada bagian ini kita akan buat service baru, untuk meng-enable akses dari luar kluster ke dalam kluster, ke pod tujuan.</p>
<p>Ok, sekarang tambahakn konfigurasi berikut ke file <code>k8s.yaml</code>.</p>
<pre><code class="lang-bash">---
<span class="hljs-comment"># pilih API `v1` untuk blok konfigurasi service.</span>
apiVersion: v1

<span class="hljs-comment"># alokasikan blok YAML berikut untuk service.</span>
kind: Service

<span class="hljs-comment"># namai dengan `my-service`.</span>
metadata:
  name: my-service

<span class="hljs-comment"># blok spec berikut berisi spesifikasi behaviour dari objek service ini.</span>
spec:

  <span class="hljs-comment"># tipe dari service yang dipilih adalah LoadBalancer.</span>
  <span class="hljs-comment">#</span>
  <span class="hljs-comment"># LoadBalancer service adalah pilihan standar untuk meng-expose sebuah service ke public.</span>
  <span class="hljs-comment"># Akan disiapkan sebuah network load balancer dengan satu buah public IP, dan nantinya</span>
  <span class="hljs-comment"># semua request yang masuk ke IP tersebut akan diproses oleh service.</span>
  <span class="hljs-comment">#</span>
  <span class="hljs-comment"># pada provider cloud, nantinya akan digenerate satu buah public IP.</span>
  <span class="hljs-comment"># tapi pada lokal (minikube), service akan bisa diakses lewat IP minikube.</span>
  <span class="hljs-built_in">type</span>: LoadBalancer

  <span class="hljs-comment"># route trafik pada service ke pod dengan label berikut.</span>
  selector:
    app: my-app

  <span class="hljs-comment"># list port yang di expose di service ini.</span>
  ports:

      <span class="hljs-comment"># expose service port ke luar kluster (dalam konteks ini ke luar minikube).</span>
      <span class="hljs-comment"># jadi untuk mengakses service, gunakan public IP + nodePort berikut.</span>
      <span class="hljs-comment">#</span>
      <span class="hljs-comment"># cara untuk menampilkan exposed URL (public IP + nodePort):</span>
      <span class="hljs-comment"># `minikube service my-service --url`.</span>
      <span class="hljs-comment">#   =&gt; http://&lt;cluster-public-ip&gt;:&lt;nodePort&gt;</span>
    - nodePort: 32199

      <span class="hljs-comment"># request yang masuk dari luar ke nodePort, akan diarahkan ke port 80 milik service ini.</span>
      <span class="hljs-comment">#</span>
      <span class="hljs-comment"># cara untuk menampilkan service URL (dalam kluster):</span>
      <span class="hljs-comment"># `kubectl describe service my-service | findstr &quot;IP&quot;`.</span>
      <span class="hljs-comment">#   =&gt; http://&lt;service-ip&gt;:&lt;port&gt;</span>
      port: 80

      <span class="hljs-comment"># setelah itu, dari port 80 milik service akan di arahkan ke pod yang tersedia,</span>
      <span class="hljs-comment"># menggunakan algoritma round-robin (load balancer),</span>
      <span class="hljs-comment"># ke pod IP dengan port targetPort berikut.</span>
      <span class="hljs-comment">#</span>
      <span class="hljs-comment">#  =&gt; http://&lt;pod-ip&gt;:&lt;targetPort&gt;</span>
      targetPort: 8080
</code></pre>
<p><code>LoadBalancer</code> dipilih sebagai tipe service ini. Load balancer nantinya akan menerima request dari luar kluster (pada <code>&lt;publicIP&gt;:&lt;nodePort&gt;</code>), untuk diarahkan ke port <code>80</code> milik service dalam kluster, lalu di-teruskan ke pod (ke <code>&lt;pod&gt;:&lt;targetPort&gt;</code>) menggunakan algoritma umum load balancer (round-robin).</p>
<blockquote>
<p>Sebenarnya dalam contoh ini kita tidak harus menggunakan tipe <code>LoadBalancer</code>, tipe <code>NodePort</code> juga bisa dipergunakan.</p>
</blockquote>
<p>Satu point penting yang perlu dicatat disini, karena kluster kita adalah Minikube, maka public IP disini adalah public IP dari Minikube. Untuk menampilkan IP Minikube, bisa gunakan command berikut:</p>
<pre><code class="lang-bash"><span class="hljs-comment"># tampilkan minikube IP</span>
minikube ip
</code></pre>
<p>Ok, sekarang mari kita terapkan konfigurasi <code>k8s.yaml</code> yang sudah ditambahkan service didalamnya.</p>
<pre><code class="lang-bash"><span class="hljs-comment"># terapkan konfigurasi</span>
kubectl apply <span class="hljs-_">-f</span> k8s.yaml

<span class="hljs-comment"># munculkan semua objek service</span>
kubectl get services

<span class="hljs-comment"># munculkan semua pod</span>
kubectl get pods

<span class="hljs-comment"># test service menggunakan `curl`</span>
curl &lt;minikubeIP&gt;:&lt;nodePort&gt;
curl &lt;minikubeIP&gt;:32199
</code></pre>
<p style="text-align: center;">
  <img src="https://i.imgur.com/IoEpMFH.jpg" alt="Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Autoscaler - membuat objek service">
</p>

<p>Bisa dilihat dari gambar di atas, kita telah men-<em>dispatch</em> beberapa HTTP request ke service yang sudah kita buat. Hasil response dari <code>curl</code> berbeda satu sama lain, hal ini karena pod yang menerima dan merespon request kita adalah berbeda di tiap request (efek dari load balancer).</p>
<blockquote>
<p>Tips! Cara yang lebih praktis untuk mendapatkan URL service, gunakan command berikut:</p>
<p><code>minikube service &lt;service-name&gt; --url</code><br><code>minikube service my-service --url</code></p>
</blockquote>
<h4 id="33-objek-horizontal-pod-auto-scaler-hpa">3.3. Objek Horizontal Pod Auto Scaler (HPA)</h4>
<p>Pada bagian ini, kita akan menambahkan kapabilitas autoscaling pada pod. Jadi, semisal nantinya muncul lonjakan jumlah pengakses aplikasi, maka jumlah pod akan di scale secara otomatis untuk mengakomodir kebutuhan tersebut.</p>
<p>Salah satu cara untuk menerapkan autoscaling pada pod adalah dengan menambahkan objek HPA. Objek ini akan secara cerdas me-<em>manage</em> proses <em>scaling</em> pod, kapan harus disiapkan banyak replikasi pod, kapan harus sedikit. Kita bisa menambahkan kriteria scaling berdasarkan misalnya utilisasi CPU, atau lainnya.</p>
<p>Ok, sekarang tambahkan konfigurasi berikut ke file <code>k8s.yaml</code>.</p>
<pre><code class="lang-yaml"><span class="hljs-meta">---</span>
<span class="hljs-comment"># pilih api `autoscaling/v2beta2` untuk HPA.</span>
<span class="hljs-attr">apiVersion:</span> autoscaling/v2beta2

<span class="hljs-comment"># alokasikan blok YAML berikut untuk HPA (HorizontalPodAutoscaler).</span>
<span class="hljs-attr">kind:</span> HorizontalPodAutoscaler

<span class="hljs-comment"># namai dengan `my-auto-scaler`.</span>
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> my-auto-scaler

<span class="hljs-comment"># blok spec berikut berisi spesifikasi behaviour dari objek autoscaler ini.</span>
<span class="hljs-attr">spec:</span>

  <span class="hljs-comment"># minimum replikasi pod.</span>
<span class="hljs-attr">  minReplicas:</span> <span class="hljs-number">3</span>

  <span class="hljs-comment"># maksimum replikasi pod.</span>
<span class="hljs-attr">  maxReplicas:</span> <span class="hljs-number">10</span>

  <span class="hljs-comment"># objek deployment yang ingin di-scale.</span>
<span class="hljs-attr">  scaleTargetRef:</span>
<span class="hljs-attr">    apiVersion:</span> apps/v1
<span class="hljs-attr">    kind:</span> Deployment
<span class="hljs-attr">    name:</span> my-app-deployment

  <span class="hljs-comment"># blok metrics berikut berisi kriteria yang dijadikan acuan untuk scaling.</span>
<span class="hljs-attr">  metrics:</span>

      <span class="hljs-comment"># kriteria scaling: ketika utilisasi CPU 50%.</span>
<span class="hljs-attr">    - type:</span> Resource
<span class="hljs-attr">      resource:</span>
<span class="hljs-attr">        name:</span> cpu
<span class="hljs-attr">        target:</span>
<span class="hljs-attr">          type:</span> Utilization
<span class="hljs-attr">          averageUtilization:</span> <span class="hljs-number">50</span>
</code></pre>
<p>Penulis rasa penjelasan pada komentar tiap bagian di konfigurasi di atas cukup jelas. Intinya, proses scaling akan diterapkan ke objek deployment <code>my-app-deployment</code>, dengan kriteria utilisasi CPU 50%, dengan minimum pod 3 dan maksimum 10.</p>
<p>Ok, sekarang mari kita terapkan file konfigurasi yang sudah ditambahkan HPA di dalamnya.</p>
<pre><code class="lang-bash"><span class="hljs-comment"># terapkan file konfigurasi</span>
kubectl apply <span class="hljs-_">-f</span> k8s.yaml

<span class="hljs-comment"># munculkan semua HPA</span>
kubectl get hpa

<span class="hljs-comment"># munculkan detail HPA</span>
kubectl describe hpa &lt;hpa-name&gt;
</code></pre>
<p style="text-align: center;">
  <img src="https://i.imgur.com/R63y8dL.png" alt="Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Autoscaler - objek horizontal pod auto scaler">
</p>


<p>Sebelumnya kita punya dua pod <em>running</em>. Setelah HPA diterapkan, default pod yang running menjadi 3, hal ini karena <code>spec.minReplicas</code> kita isi nilainya 3.</p>
<h4 id="331-stress-test-pada-hpa">3.3.1. Stress test pada HPA</h4>
<p>Mari kita test objek HPA yang sudah dibuat. Kita akan simulasikan trafik tinggi menggunakan <code>hey</code> tool. Sejumlah 50 concurrent request akan di-<em>dispatch</em> ke URL service selama 5 menit.</p>
<p>Jalankan command berikut pada window PowerShell baru.</p>
<pre><code class="lang-bash"><span class="hljs-comment"># munculkan URL service</span>
minikube service my-service --url

<span class="hljs-comment"># simulasikan stress test</span>
hey -c 50 -z 5m &lt;service-URL&gt;
</code></pre>
<p>Sekarang fokus ke PowerShell satunya, cek perilaku pod setelah beberapa menit.</p>
<pre><code class="lang-bash"><span class="hljs-comment"># munculkan semua hpa dan pod</span>
kubectl get hpa
kubectl get pods
</code></pre>
<p style="text-align: center;">
  <img src="https://i.imgur.com/0lHYlxc.png" alt="Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Autoscaler - objek HPA">
</p>

<p>Setelah satu menit berlalu, tiba-tiba ada 6 buah pod yang running. Ini terjadi karena utilisasi CPU cukup tinggi, memenuhi kriteria scaling yang sudah didefinisikan. Bisa disimpulkan berarti proses autoscaling berjalan sesuai harapan.</p>
<p>HPA tidak hanya secara magis bisa me-manage jumlah pod ketika tinggi traffik, tapi juga ketika trafik rendah. Coba hentikan stress test, lalu tunggu beberapa menit kemudian cek lagi HPA dan pod, maka angka akan berubah seperti awal.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Kubernetes - Deploy Aplikasi ke Kluster Minikube menggunakan Deployment controller, Service, dan Horizontal Pod Autoscaler","level":"1.7","depth":1,"next":{"title":"Terraform","level":"1.8","depth":1,"ref":"","articles":[]},"previous":{"title":"Kubernetes","level":"1.6","depth":1,"ref":"","articles":[]},"dir":"ltr"},"config":{"plugins":["ga","disqus"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"ga":{"configuration":"auto","token":"UA-27602984-32"},"disqus":{"useIdentifier":false,"shortName":"devops-novalagung-com"},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","lunr":{"maxIndexSize":1000000000},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"language":"id","gitbook":"*"},"file":{"path":"kubernetes-minikube-deployment-service-horizontal-autoscale.md","mtime":"2020-06-12T09:10:49.432Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-06-12T09:11:44.013Z"},"basePath":".","book":{"language":"id"}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    <div style="position: fixed; top: 10px; right: 30px; padding: 10px; background-color: rgba(255, 255, 255, 0.7);"><a class="github-button" href="https://github.com/novalagung" data-size="large" aria-label="Follow @novalagung on GitHub">Follow @novalagung</a><script async defer src="https://buttons.github.io/buttons.js"></script></div><div class="banner-container" onclick="this.style.display = 'none';"><div><a target="_blank" href="https://www.udemy.com/course/praktis-belajar-docker-dan-kubernetes-untuk-pemula/"><img src="https://dasarpemrogramangolang.novalagung.com/images/banner.png?v=1.2020.06.12.091147"></a></div></div><script>var bannerCounter = parseInt(localStorage.getItem("banner-counter")); if (isNaN(bannerCounter)) { bannerCounter = 0; } var bannerEl = document.querySelector('.banner-container'); if (bannerCounter % 5 === 0 && bannerEl) { bannerEl.style.display = 'block'; } localStorage.setItem("banner-counter", String(bannerCounter + 1));</script></body>
</html>

